<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Validador de PDFs</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZMHK58V1KG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ZMHK58V1KG');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
</head>
<body>

<div class="card">
    <div class="header-row">
        <h1>Validador</h1>
        <button id="btnAyuda" class="btn-ayuda" onclick="document.getElementById('helpModal').style.display='block'">‚ùì Ayuda</button>
    </div>

    <div class="config-section">
        <div class="select-wrapper">
            <label for="tipoValidacion">Tipo de validaci√≥n</label>
            <select id="tipoValidacion">
                <option value="evento">üìã Por evento</option>
                <option value="paquete" selected>üì¶ Por paquete</option>
            </select>
        </div>

        <div id="paqueteOptions" class="paquete-options">
            <div class="select-wrapper">
                <label for="tipoPaquete">Tipo de paquete</label>
                <select id="tipoPaquete">
                    <option value="cronico">üè• Cr√≥nico</option>
                    <option value="cronico-terapias" selected>üíä Cr√≥nico con terapias</option>
                </select>
            </div>
        </div>

        <div class="select-wrapper">
            <label for="convenio">Convenio</label>
            <select id="convenio">
                <option value="capital-salud">üè¢ Capital Salud</option>
                <option value="fomag" selected>üèõÔ∏è FOMAG</option>
            </select>
        </div>
    </div>

    <label class="file">
        üìÅ Seleccionar carpeta
        <input type="file" id="inputFolder" webkitdirectory directory multiple />
    </label>
    <button id="btnAbrirFS" class="btn-limpiar">‚ö° Abrir carpeta (r√°pido)</button>

    <button id="btnDescargar" class="btn-descargar oculto">‚¨áÔ∏è Descargar XLSX</button>

    <button id="btnLimpiar" class="btn-limpiar-todo oculto">üóëÔ∏è Limpiar todo</button>

    <!-- Modal de progreso de descarga -->
    <div id="modalProgresoBajada" class="modal-progreso-bajada oculto">
        <div class="modal-progreso-bajada-contenido">
            <h3>üì• Preparando archivo XLSX...</h3>
            <div class="progreso-barra-bajada">
                <div id="progresoFillBajada" class="progreso-fill-bajada"></div>
            </div>
            <div class="progreso-info-bajada">
                <span id="progresoPorcentajeBajada">0%</span>
                <span id="progresoTextoBajada">Iniciando...</span>
            </div>
        </div>
    </div>

    <div id="estado" class="estado oculto"></div>

    <!-- Barra de progreso -->
    <div id="barraProgreso" class="barra-progreso oculto">
        <div class="progreso-header">
            <div class="progreso-info">
                <span id="progresoTexto">Procesando...</span>
                <span id="progresoDetalle" class="progreso-detalle"></span>
            </div>
            <span id="progresoPorcentaje" class="progreso-porcentaje">0%</span>
        </div>
        <div class="progreso-barra">
            <div id="progresoFill" class="progreso-fill"></div>
        </div>
    </div>

    <!-- Resumen de validaci√≥n -->
    <div id="resumen" class="resumen oculto">
        <h3>üìä Resumen de Validaci√≥n</h3>
        <div class="resumen-container">
            <!-- Columna izquierda: Estad√≠sticas generales -->
            <div class="resumen-general">
                <div class="resumen-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total carpetas:</span>
                        <span class="stat-value" id="statTotal">0</span>
                    </div>
                    <div class="stat-item success">
                        <span class="stat-label">‚úî Sin errores:</span>
                        <span class="stat-value" id="statExito">0</span>
                    </div>
                    <div class="stat-item warning">
                        <span class="stat-label">‚ö† Con alertas:</span>
                        <span class="stat-value" id="statAlertas">0</span>
                    </div>
                    <div class="stat-item error">
                        <span class="stat-label">‚úñ Con errores:</span>
                        <span class="stat-value" id="statErrores">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Columna derecha: Errores por tipo -->
            <div id="resumenErrores" class="resumen-errores oculto">
                <h4>üìÑ Errores por tipo</h4>
                <div id="listaErrores" class="lista-errores"></div>
            </div>
        </div>
    </div>

    <!-- Barra de b√∫squeda y filtros -->
    <div id="filtros" class="filtros oculto">
        <div class="filtro-item">
            <label for="buscarDocumento">üîç Buscar por documento:</label>
            <input type="text" id="buscarDocumento" placeholder="Ingrese n√∫mero de documento..." />
        </div>
        <div class="filtro-item">
            <label for="filtroEstado">üìä Filtrar por estado:</label>
            <select id="filtroEstado">
                <option value="">üìã Todos los estados</option>
                <option value="sin-errores">‚úÖ Sin errores</option>
                <option value="con-alertas">‚ö†Ô∏è Con alertas</option>
                <option value="con-errores">‚ùå Con errores</option>
            </select>
        </div>
        <div class="filtro-item">
            <label for="filtroServicio">üè• Filtrar por servicio:</label>
            <select id="filtroServicio">
                <option value="">üéØ Todos los servicios</option>
                <option value="VM">ü©∫ VM - Visita M√©dica</option>
                <option value="ENF">üíâ ENF - Enfermer√≠a</option>
                <option value="TF">üèÉ TF - Terapia F√≠sica</option>
                <option value="TR">ü´Å TR - Terapia Respiratoria</option>
                <option value="SUCCION">üå¨Ô∏è SUCCION - Terapia Succi√≥n</option>
                <option value="PSI">üß† PSI - Psicolog√≠a</option>
                <option value="TS">üë• TS - Trabajo Social</option>
                <option value="FON">üó£Ô∏è FON - Fonoaudiolog√≠a</option>
            </select>
        </div>
        <div class="filtro-item checkbox-item destacado">
            <label>
                <input type="checkbox" id="mostrarExitos" />
                ‚úì Mostrar validaciones exitosas
            </label>
        </div>
        <button id="limpiarFiltros" class="btn-limpiar">üîÑ Limpiar filtros</button>
    </div>

    <div class="table-wrapper">
        <table id="tabla">
            <thead id="tablaHeader">
                <tr>
                    <th>Tipo</th>
                    <th>Carpeta</th>
                    <th>2.pdf</th>
                    <th>3.pdf</th>
                    <th>4.pdf</th>
                    <th>5.pdf</th>
                    <th>Cant.</th>
                    <th>Evoluciones (cantidad y detalle)</th>
                    <th>Errores</th>
                </tr>
            </thead>
            <tbody id="tablaBody"></tbody>
        </table>
    </div>
</div>

<!-- Modal para mostrar PDFs -->
<div id="pdfModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="pdfModalTitle">PDF</h2>
            <span class="modal-close" onclick="cerrarModal()">&times;</span>
        </div>
        <div class="modal-body">
            <iframe id="pdfFrame" src="" frameborder="0"></iframe>
        </div>
    </div>
</div>

<!-- Modal de ayuda -->
<div id="helpModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Gu√≠a r√°pida</h2>
            <span class="modal-close" onclick="document.getElementById('helpModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
            <div class="help-content">
                <div class="help-filters">
                    <button class="filter-btn active" data-filter="todos">Todos</button>
                    <button class="filter-btn" data-filter="capital">Capital</button>
                    <button class="filter-btn" data-filter="fomag-evento">FOMAG Evento</button>
                    <button class="filter-btn" data-filter="fomag-paquete">FOMAG Paquete</button>
                </div>
                <div class="help-grid">
                    <div class="help-card" data-group="general">
                        <h3>üìÅ Estructura de carpetas</h3>
                        <ul class="help-list">
                            <li>Una carpeta por documento.</li>
                            <li class="scope-evento">Por <strong>Evento</strong>: el nombre de carpeta <strong>debe incluir el tipo</strong> (ej: <span class="example">123456789 ENF</span>).</li>
                            <li class="scope-paquete">Por <strong>Paquete</strong>: el nombre de carpeta debe ser <strong>solo el n√∫mero</strong> (ej: <span class="example">123456789</span>).</li>
                        </ul>
                    </div>
                    <div class="help-card card-evento" data-group="evento">
                        <h3>üßæ Evento</h3>
                        <div class="example">2.pdf, 3.pdf, 4.pdf, 5.pdf</div>
                        <ul class="help-list">
                            <li>El <strong>5.pdf</strong> contiene evoluciones del servicio (ej: "Registro De Enfermer√≠a - Actividades").</li>
                            <li>El <strong>2.pdf</strong> puede declarar autorizaciones (seg√∫n convenio).</li>
                        </ul>
                    </div>
                    <div class="help-card card-capital" data-group="capital">
                        <h3>üìë Archivos ‚Äî Capital Salud (Evento)</h3>
                        <div class="chips">
                            <span class="chip">2.pdf</span>
                            <span class="chip">3.pdf</span>
                            <span class="chip">4.pdf</span>
                            <span class="chip">5.pdf</span>
                        </div>
                        <ul class="help-list">
                            <li>La carpeta <strong>debe incluir</strong> el tipo: VM, ENF, TF, TR, SUCCION, PSI, TS, FON.</li>
                            <li><strong>2.pdf</strong>, <strong>3.pdf</strong> y <strong>5.pdf</strong> deben contener el n√∫mero de documento.</li>
                            <li>No se compara <strong>autorizaciones</strong> vs <strong>evoluciones</strong> en Capital.</li>
                            <li><strong>5.pdf</strong> debe incluir el texto del servicio (ej: "Registro De Enfermer√≠a").</li>
                            <li><strong>4.pdf</strong> firmas: se espera <strong>1 p√°gina</strong>; si contiene "identificaci√≥n" se muestra <strong>alerta</strong>.</li>
                        </ul>
                    </div>
                    <div class="help-card card-fomag-evento" data-group="fomag-evento">
                        <h3>üìë Archivos ‚Äî FOMAG (Evento)</h3>
                        <div class="chips">
                            <span class="chip">2.pdf</span>
                            <span class="chip">4.pdf</span>
                            <span class="chip">5.pdf</span>
                        </div>
                        <ul class="help-list">
                            <li>En <strong>2.pdf</strong> las <strong>autorizaciones</strong> deben ser <strong>mayor o igual</strong> a las <strong>evoluciones</strong> del 5.pdf.</li>
                            <li><strong>2.pdf</strong> y <strong>5.pdf</strong> deben contener el n√∫mero de documento.</li>
                        </ul>
                    </div>
                    <div class="help-card" data-group="fomag-paquete">
                        <h3>üì¶ Paquete</h3>
                            <div class="chips">
                                <span class="chip">2 vm.pdf</span>
                                <span class="chip">4 vm.pdf</span>
                                <span class="chip">5 vm.pdf</span>
                                <span class="chip">2 enf.pdf</span>
                                <span class="chip">4 enf.pdf</span>
                                <span class="chip">5 enf.pdf</span>
                                <span class="chip">‚Ä¶ (TF/TR/SUCCION/TO/TS/PSI/FON)</span>
                            </div>
                        <ul class="help-list">
                                <li>En <strong>FOMAG</strong> puede existir <span class="chip">2 paq.pdf</span>, que declara autorizaciones de <strong>varios servicios</strong>.</li>
                                <li>Tambi√©n puede haber <strong>2 [servicio].pdf</strong> individual. <strong>Prioridad:</strong> si existe individual, se usa ese; si no, se toma lo de <span class="chip">2 paq.pdf</span>.</li>
                                <li>Las <strong>autorizaciones</strong> del 2.pdf deben <strong>igualar</strong> las <strong>evoluciones</strong> del 5.pdf.</li>
                                <li><strong>2 [servicio].pdf</strong> y <strong>5 [servicio].pdf</strong> deben contener el n√∫mero de documento.</li>
                        </ul>
                    </div>
                    <div class="help-card">
                            <h3>üè• Servicios y textos</h3>
                            <div class="help-badges">
                                <span class="badge">VM ‚Äî Valoraci√≥n M√©dica</span>
                                <span class="badge">ENF ‚Äî Enfermer√≠a</span>
                                <span class="badge">TF ‚Äî Terapia F√≠sica</span>
                                <span class="badge">TR ‚Äî Terapia Respiratoria</span>
                                <span class="badge">SUCCION ‚Äî Terapia Succi√≥n</span>
                                <span class="badge">TO ‚Äî Terapia Ocupacional</span>
                                <span class="badge">TS ‚Äî Trabajo Social</span>
                                <span class="badge">PSI ‚Äî Psicolog√≠a</span>
                                <span class="badge">FON ‚Äî Fonoaudiolog√≠a</span>
                            </div>
                            <ul class="help-list">
                                <li><strong>5.pdf</strong>: "Registro De ‚Ä¶" (ej: "Registro De Fonoaudiolog√≠a").</li>
                                <li><strong>2.pdf (FOMAG)</strong>: "ATENCION (VISITA) DOMICILIARIA, POR ‚Ä¶" (ej: "‚Ä¶ FONIATRIA Y FONOAUDIOLOGIA").</li>
                            </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Filtros de ayuda
(function(){
  const btns = document.querySelectorAll('#helpModal .filter-btn');
  const cards = document.querySelectorAll('#helpModal .help-card');
  function aplicar(filtro){
    btns.forEach(b=>b.classList.toggle('active', b.dataset.filter===filtro));
    cards.forEach(c=>{
      const group = c.getAttribute('data-group')||'general';
            const visible = filtro==='todos' ||
                (filtro==='capital' && (group==='capital' || group==='general')) ||
                (filtro==='fomag-evento' && (group==='fomag-evento' || group==='general')) ||
                (filtro==='fomag-paquete' && (group==='fomag-paquete' || group==='general'));
      c.style.display = visible ? '' : 'none';
    });

        // Mostrar/ocultar detalles espec√≠ficos dentro de tarjetas generales
        const showPaquete = filtro==='fomag-paquete' || filtro==='todos';
        const showEvento = filtro!=='fomag-paquete';
        document.querySelectorAll('#helpModal .scope-paquete').forEach(el=>{
            el.style.display = showPaquete ? '' : 'none';
        });
        document.querySelectorAll('#helpModal .scope-evento').forEach(el=>{
            el.style.display = showEvento ? '' : 'none';
        });
  }
  btns.forEach(b=>b.addEventListener('click',()=>aplicar(b.dataset.filter)));
    // Aplicar filtro inicial
    aplicar('todos');
})();
</script>

<script type="module" src="src/app.js"></script>
</body>
</html>
