<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Validador de PDFs</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZMHK58V1KG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ZMHK58V1KG');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
</head>
<body>

<div class="card">
    <div class="header-row">
        <h1>Validador</h1>
        <button id="btnAyuda" class="btn-ayuda" onclick="toggleWiki()">‚ùì Ayuda</button>
    </div>

    <div class="config-section">
        <div class="select-wrapper">
            <label for="tipoValidacion">Tipo de validaci√≥n</label>
            <select id="tipoValidacion">
                <option value="evento">üìã Por evento</option>
                <option value="paquete" selected>üì¶ Por paquete</option>
            </select>
        </div>

        <div id="paqueteOptions" class="paquete-options">
            <div class="select-wrapper">
                <label for="tipoPaquete">Tipo de paquete</label>
                <select id="tipoPaquete">
                    <option value="cronico">üè• Cr√≥nico</option>
                    <option value="cronico-terapias" selected>üíä Cr√≥nico con terapias</option>
                </select>
            </div>
        </div>

        <div class="select-wrapper">
            <label for="convenio">Convenio</label>
            <select id="convenio">
                <option value="capital-salud">üè¢ Capital Salud</option>
                <option value="fomag" selected>üèõÔ∏è FOMAG</option>
            </select>
        </div>
    </div>

    <label class="file">
        üìÅ Seleccionar carpeta
        <input type="file" id="inputFolder" webkitdirectory directory multiple />
    </label>
    <button id="btnAbrirFS" class="btn-limpiar">‚ö° Abrir carpeta (r√°pido)</button>

    <button id="btnDescargar" class="btn-descargar oculto">‚¨áÔ∏è Descargar XLSX</button>

    <button id="btnLimpiar" class="btn-limpiar-todo oculto">üóëÔ∏è Limpiar todo</button>

    <!-- Modal de progreso de descarga -->
    <div id="modalProgresoBajada" class="modal-progreso-bajada oculto">
        <div class="modal-progreso-bajada-contenido">
            <h3>üì• Preparando archivo XLSX...</h3>
            <div class="progreso-barra-bajada">
                <div id="progresoFillBajada" class="progreso-fill-bajada"></div>
            </div>
            <div class="progreso-info-bajada">
                <span id="progresoPorcentajeBajada">0%</span>
                <span id="progresoTextoBajada">Iniciando...</span>
            </div>
        </div>
    </div>

    <div id="estado" class="estado oculto"></div>

    <!-- Barra de progreso -->
    <div id="barraProgreso" class="barra-progreso oculto">
        <div class="progreso-header">
            <div class="progreso-info">
                <span id="progresoTexto">Procesando...</span>
                <span id="progresoDetalle" class="progreso-detalle"></span>
            </div>
            <span id="progresoPorcentaje" class="progreso-porcentaje">0%</span>
        </div>
        <div class="progreso-barra">
            <div id="progresoFill" class="progreso-fill"></div>
        </div>
    </div>

    <!-- Resumen de validaci√≥n -->
    <div id="resumen" class="resumen oculto">
        <h3>üìä Resumen de Validaci√≥n</h3>
        <div class="resumen-container">
            <!-- Columna izquierda: Estad√≠sticas generales -->
            <div class="resumen-general">
                <div class="resumen-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total carpetas:</span>
                        <span class="stat-value" id="statTotal">0</span>
                    </div>
                    <div class="stat-item success">
                        <span class="stat-label">‚úî Sin errores:</span>
                        <span class="stat-value" id="statExito">0</span>
                    </div>
                    <div class="stat-item warning">
                        <span class="stat-label">‚ö† Con alertas:</span>
                        <span class="stat-value" id="statAlertas">0</span>
                    </div>
                    <div class="stat-item error">
                        <span class="stat-label">‚úñ Con errores:</span>
                        <span class="stat-value" id="statErrores">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Columna derecha: Errores por tipo -->
            <div id="resumenErrores" class="resumen-errores oculto">
                <h4>üìÑ Errores por tipo</h4>
                <div id="listaErrores" class="lista-errores"></div>
            </div>
        </div>
    </div>

    <!-- Barra de b√∫squeda y filtros -->
    <div id="filtros" class="filtros oculto">
        <div class="filtro-item">
            <label for="buscarDocumento">üîç Buscar por documento:</label>
            <input type="text" id="buscarDocumento" placeholder="Ingrese n√∫mero de documento..." />
        </div>
        <div class="filtro-item">
            <label for="filtroEstado">üìä Filtrar por estado:</label>
            <select id="filtroEstado">
                <option value="">üìã Todos los estados</option>
                <option value="sin-errores">‚úÖ Sin errores</option>
                <option value="con-alertas">‚ö†Ô∏è Con alertas</option>
                <option value="con-errores">‚ùå Con errores</option>
            </select>
        </div>
        <div class="filtro-item">
            <label for="filtroServicio">üè• Filtrar por servicio:</label>
            <select id="filtroServicio">
                <option value="">üéØ Todos los servicios</option>
                <option value="VM">ü©∫ VM - Visita M√©dica</option>
                <option value="ENF">üíâ ENF - Enfermer√≠a</option>
                <option value="TF">üèÉ TF - Terapia F√≠sica</option>
                <option value="TR">ü´Å TR - Terapia Respiratoria</option>
                <option value="SUCCION">üå¨Ô∏è SUCCION - Terapia Succi√≥n</option>
                <option value="PSI">üß† PSI - Psicolog√≠a</option>
                <option value="TS">üë• TS - Trabajo Social</option>
                <option value="FON">üó£Ô∏è FON - Fonoaudiolog√≠a</option>
            </select>
        </div>
        <div class="filtro-item checkbox-item destacado">
            <label>
                <input type="checkbox" id="mostrarExitos" />
                ‚úì Mostrar validaciones exitosas
            </label>
        </div>
        <button id="limpiarFiltros" class="btn-limpiar">üîÑ Limpiar filtros</button>
    </div>

    <div class="table-wrapper">
        <table id="tabla">
            <thead id="tablaHeader">
                <tr>
                    <th>Tipo</th>
                    <th>Carpeta</th>
                    <th>2.pdf</th>
                    <th>3.pdf</th>
                    <th>4.pdf</th>
                    <th>5.pdf</th>
                    <th>Cant.</th>
                    <th>Evoluciones (cantidad y detalle)</th>
                    <th>Errores</th>
                </tr>
            </thead>
            <tbody id="tablaBody"></tbody>
        </table>
    </div>
</div>

<!-- Modal para mostrar PDFs -->
<div id="pdfModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="pdfModalTitle">PDF</h2>
            <span class="modal-close" onclick="cerrarModal()">&times;</span>
        </div>
        <div class="modal-body">
            <iframe id="pdfFrame" src="" frameborder="0"></iframe>
        </div>
    </div>
</div>

<!-- Wiki Section -->
<div id="wikiContainer" class="wiki-container oculto">
    <div class="wiki-modal-wrapper">
        <div class="wiki-sidebar">
        <div class="wiki-sidebar-header">
            <h3>üìö Documentaci√≥n</h3>
            <button class="wiki-close" onclick="toggleWiki()">&times;</button>
        </div>
        <nav class="wiki-nav">
            <a href="#wiki-inicio" class="wiki-nav-item active" onclick="showWikiSection('inicio')">üè† Inicio</a>
            <div class="wiki-nav-section">Conceptos b√°sicos</div>
            <a href="#wiki-estructura" class="wiki-nav-item" onclick="showWikiSection('estructura')">üìÅ Estructura de carpetas</a>
            <a href="#wiki-servicios" class="wiki-nav-item" onclick="showWikiSection('servicios')">üè• Servicios</a>
            <div class="wiki-nav-section">Por convenio</div>
            <a href="#wiki-capital" class="wiki-nav-item" onclick="showWikiSection('capital')">üìë Capital Salud</a>
            <a href="#wiki-fomag-evento" class="wiki-nav-item" onclick="showWikiSection('fomag-evento')">üìã FOMAG Evento</a>
            <a href="#wiki-fomag-paquete" class="wiki-nav-item" onclick="showWikiSection('fomag-paquete')">üì¶ FOMAG Paquete</a>
            <div class="wiki-nav-section">Referencia</div>
            <a href="#wiki-errores" class="wiki-nav-item" onclick="showWikiSection('errores')">‚ö†Ô∏è Tipos de errores</a>
        </nav>
    </div>
    <div class="wiki-content">
        <!-- Inicio -->
        <article id="wiki-inicio" class="wiki-article">
            <h1>üìö Gu√≠a de validaci√≥n de PDFs</h1>
            <p class="wiki-intro">Bienvenido a la documentaci√≥n del validador. Esta herramienta verifica que los PDFs cumplan con los requisitos seg√∫n el convenio y tipo de validaci√≥n.</p>
            
            <div class="wiki-quick-links">
                <div class="wiki-card">
                    <h3>üöÄ Inicio r√°pido</h3>
                    <ol>
                        <li>Selecciona el tipo de validaci√≥n (Evento o Paquete)</li>
                        <li>Elige el convenio (Capital Salud o FOMAG)</li>
                        <li>Carga la carpeta con los documentos</li>
                        <li>Revisa los resultados en la tabla</li>
                    </ol>
                </div>
                <div class="wiki-card">
                    <h3>üìñ Secciones principales</h3>
                    <ul>
                        <li><a href="#wiki-estructura" onclick="showWikiSection('estructura')">Estructura de carpetas</a></li>
                        <li><a href="#wiki-capital" onclick="showWikiSection('capital')">Capital Salud</a></li>
                        <li><a href="#wiki-fomag-evento" onclick="showWikiSection('fomag-evento')">FOMAG Evento</a></li>
                        <li><a href="#wiki-fomag-paquete" onclick="showWikiSection('fomag-paquete')">FOMAG Paquete</a></li>
                    </ul>
                </div>
            </div>
        </article>

        <!-- Estructura -->
        <article id="wiki-estructura" class="wiki-article oculto">
            <h1>üìÅ Estructura de carpetas</h1>
            <p>La organizaci√≥n de las carpetas es fundamental para que el validador funcione correctamente.</p>
            
            <h2>Reglas generales</h2>
            <ul class="wiki-list">
                <li>Cada carpeta representa un documento √∫nico</li>
                <li>El nombre de la carpeta debe contener el n√∫mero de documento</li>
            </ul>

            <h2>Por Evento</h2>
            <div class="wiki-note info">
                <strong>Formato:</strong> <code>[n√∫mero_documento] [TIPO]</code>
            </div>
            <div class="wiki-example">
                <strong>Ejemplo:</strong> <code>123456789 ENF</code>
            </div>
            <p>El tipo debe ser uno de: VM, ENF, TF, TR, SUCCION, PSI, TS, FON</p>

            <h2>Por Paquete</h2>
            <div class="wiki-note info">
                <strong>Formato:</strong> <code>[n√∫mero_documento]</code>
            </div>
            <div class="wiki-example">
                <strong>Ejemplo:</strong> <code>123456789</code>
            </div>
            <p>Solo el n√∫mero de documento, sin tipo de servicio.</p>
        </article>

        <!-- Servicios -->
        <article id="wiki-servicios" class="wiki-article oculto">
            <h1>üè• Servicios y textos</h1>
            <p>Cada servicio tiene textos espec√≠ficos que deben aparecer en los PDFs.</p>

            <h2>Lista de servicios</h2>
            <div class="wiki-table">
                <table>
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><code>VM</code></td><td>Valoraci√≥n M√©dica</td></tr>
                        <tr><td><code>ENF</code></td><td>Enfermer√≠a</td></tr>
                        <tr><td><code>TF</code></td><td>Terapia F√≠sica</td></tr>
                        <tr><td><code>TR</code></td><td>Terapia Respiratoria</td></tr>
                        <tr><td><code>SUCCION</code></td><td>Terapia Succi√≥n</td></tr>
                        <tr><td><code>TO</code></td><td>Terapia Ocupacional</td></tr>
                        <tr><td><code>TS</code></td><td>Trabajo Social</td></tr>
                        <tr><td><code>PSI</code></td><td>Psicolog√≠a</td></tr>
                        <tr><td><code>FON</code></td><td>Fonoaudiolog√≠a</td></tr>
                    </tbody>
                </table>
            </div>

            <h2>Textos esperados</h2>
            <h3>En 5.pdf (Evoluciones)</h3>
            <p>Debe contener: <code>"Registro De [Servicio]"</code></p>
            <div class="wiki-example">
                Ejemplos: "Registro De Fonoaudiolog√≠a", "Registro De Enfermer√≠a - Actividades"
            </div>

            <h3>En 2.pdf FOMAG (Autorizaciones)</h3>
            <p>Debe contener: <code>"ATENCION (VISITA) DOMICILIARIA, POR ..."</code></p>
            <div class="wiki-example">
                Ejemplo: "... FONIATRIA Y FONOAUDIOLOGIA"
            </div>
        </article>

        <!-- Capital Salud -->
        <article id="wiki-capital" class="wiki-article oculto">
            <h1>üìë Capital Salud (Evento)</h1>
            
            <h2>Archivos requeridos</h2>
            <div class="wiki-chips">
                <span class="wiki-chip">2.pdf</span>
                <span class="wiki-chip">3.pdf</span>
                <span class="wiki-chip">4.pdf</span>
                <span class="wiki-chip">5.pdf</span>
            </div>

            <h2>Requisitos</h2>
            <ul class="wiki-list">
                <li>La carpeta <strong>debe incluir</strong> el tipo de servicio (VM, ENF, TF, TR, SUCCION, PSI, TS, FON)</li>
                <li><strong>2.pdf</strong>, <strong>3.pdf</strong> y <strong>5.pdf</strong> deben contener el n√∫mero de documento</li>
                <li><strong>5.pdf</strong> debe incluir el texto del servicio (ej: "Registro De Enfermer√≠a")</li>
            </ul>

            <h2>Validaciones espec√≠ficas</h2>
            <div class="wiki-note warning">
                <strong>4.pdf (Firmas):</strong> Se espera <strong>1 p√°gina</strong>. Si contiene "identificaci√≥n" se muestra alerta.
            </div>
            <div class="wiki-note info">
                <strong>Nota:</strong> No se compara autorizaciones vs evoluciones en Capital Salud.
            </div>
        </article>

        <!-- FOMAG Evento -->
        <article id="wiki-fomag-evento" class="wiki-article oculto">
            <h1>üìã FOMAG (Evento)</h1>
            
            <h2>Archivos requeridos</h2>
            <div class="wiki-chips">
                <span class="wiki-chip">2.pdf</span>
                <span class="wiki-chip">4.pdf</span>
                <span class="wiki-chip">5.pdf</span>
            </div>

            <h2>Requisitos</h2>
            <ul class="wiki-list">
                <li><strong>2.pdf</strong> y <strong>5.pdf</strong> deben contener el n√∫mero de documento</li>
                <li>El <strong>5.pdf</strong> contiene evoluciones del servicio</li>
                <li>El <strong>2.pdf</strong> declara autorizaciones</li>
            </ul>

            <h2>Validaci√≥n de autorizaciones</h2>
            <div class="wiki-note warning">
                <strong>Importante:</strong> En <strong>2.pdf</strong> las <strong>autorizaciones</strong> deben ser <strong>mayor o igual</strong> a las <strong>evoluciones</strong> del 5.pdf.
            </div>
        </article>

        <!-- FOMAG Paquete -->
        <article id="wiki-fomag-paquete" class="wiki-article oculto">
            <h1>üì¶ FOMAG (Paquete)</h1>
            
            <h2>Archivos por servicio</h2>
            <div class="wiki-chips">
                <span class="wiki-chip">2 vm.pdf</span>
                <span class="wiki-chip">4 vm.pdf</span>
                <span class="wiki-chip">5 vm.pdf</span>
                <span class="wiki-chip">2 enf.pdf</span>
                <span class="wiki-chip">4 enf.pdf</span>
                <span class="wiki-chip">5 enf.pdf</span>
                <span class="wiki-chip">‚Ä¶ (TF/TR/SUCCION/TO/TS/PSI/FON)</span>
            </div>

            <h2>Archivo global de paquete</h2>
            <p>Puede existir <code>2 paq.pdf</code> que declara autorizaciones de varios servicios.</p>
            
            <h2>Prioridad de archivos</h2>
            <div class="wiki-note info">
                Si existe <code>2 [servicio].pdf</code> individual, se usa ese. Si no, se toma lo de <code>2 paq.pdf</code>.
            </div>

            <h2>Requisitos de servicios</h2>
            <ul class="wiki-list">
                <li>Debe incluir <strong>VM</strong> (Valoraci√≥n M√©dica)</li>
                <li>Debe incluir <strong>ENF</strong> (Enfermer√≠a)</li>
                <li>Debe incluir al menos un servicio de terapia (TF, TR, SUCCION, TO o FON)</li>
            </ul>

            <h2>Validaci√≥n de autorizaciones</h2>
            <div class="wiki-note warning">
                <strong>Importante:</strong> Las <strong>autorizaciones</strong> del 2.pdf deben <strong>igualar</strong> las <strong>evoluciones</strong> del 5.pdf.
            </div>

            <h2>Validaci√≥n de documentos</h2>
            <p><strong>2 [servicio].pdf</strong> y <strong>5 [servicio].pdf</strong> deben contener el n√∫mero de documento.</p>
        </article>

        <!-- Errores -->
        <article id="wiki-errores" class="wiki-article oculto">
            <h1>‚ö†Ô∏è Tipos de errores comunes</h1>
            
            <h2>Errores de archivos</h2>
            <div class="wiki-error-item">
                <strong>Falta [X].pdf</strong>
                <p>El archivo correspondiente no se encontr√≥ en la carpeta.</p>
            </div>
            <div class="wiki-error-item">
                <strong>[X].pdf: error leyendo PDF</strong>
                <p>El archivo puede estar corrupto o no se pudo leer.</p>
            </div>
            <div class="wiki-error-item">
                <strong>Archivo no permitido: [nombre]</strong>
                <p>Hay archivos que no siguen el patr√≥n esperado (ej: "2 vm.pdf", "4 enf.pdf", "5 tf.pdf" en validaci√≥n por evento).</p>
            </div>

            <h2>Errores de contenido</h2>
            <div class="wiki-error-item">
                <strong>[X].pdf: no contiene n√∫mero [documento]</strong>
                <p>El n√∫mero de documento no aparece en el PDF (FOMAG archivos 2 y 5).</p>
            </div>
            <div class="wiki-error-item">
                <strong>[X].pdf: falta alguno de: [textos]</strong>
                <p>No se encontr√≥ el texto requerido del servicio en el archivo.</p>
            </div>
            <div class="wiki-error-item">
                <strong>[X].pdf: no se pudo extraer el n√∫mero despu√©s del texto</strong>
                <p>En archivo 2.pdf de FOMAG, no se encontr√≥ un n√∫mero despu√©s del texto del servicio.</p>
            </div>

            <h2>Errores de validaci√≥n</h2>
            <div class="wiki-error-item">
                <strong>Cant autorizaciones [X] ‚â† cant evoluciones [Y]</strong>
                <p>El n√∫mero de autorizaciones declaradas en el 2.pdf no coincide con las evoluciones en el 5.pdf (solo FOMAG).</p>
            </div>

            <h2>Errores de paquete</h2>
            <div class="wiki-error-item">
                <strong>Paquete debe incluir servicio VM/ENF</strong>
                <p>En paquetes, se requiere siempre Valoraci√≥n M√©dica y Enfermer√≠a.</p>
            </div>
            <div class="wiki-error-item">
                <strong>Paquete debe incluir al menos un servicio de terapia</strong>
                <p>Debe haber al menos TF, TR, SUCCION, TO o FON.</p>
            </div>
        </article>
    </div>
    </div>
</div>

<script>
function toggleWiki() {
    const wiki = document.getElementById('wikiContainer');
    wiki.classList.toggle('oculto');
}

function closeWikiOnBackdrop(event) {
    if (event.target === event.currentTarget) {
        toggleWiki();
    }
}

// Cerrar wiki al hacer clic fuera
document.addEventListener('DOMContentLoaded', function() {
    const wikiContainer = document.getElementById('wikiContainer');
    if (wikiContainer) {
        wikiContainer.addEventListener('click', function(event) {
            if (event.target === wikiContainer) {
                toggleWiki();
            }
        });
    }
});

function showWikiSection(section) {
    // Ocultar todos los art√≠culos
    document.querySelectorAll('.wiki-article').forEach(art => {
        art.classList.add('oculto');
    });
    
    // Mostrar el art√≠culo seleccionado
    document.getElementById('wiki-' + section).classList.remove('oculto');
    
    // Actualizar navegaci√≥n activa
    document.querySelectorAll('.wiki-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Scroll al inicio del contenido
    document.querySelector('.wiki-content').scrollTop = 0;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script type="module" src="src/app.js"></script>
</body>
</html>
